#!/bin/bash

function badUsage()
{
    echo "jsbuild OPTIONS BUILDS"
    echo "  OPTIONS:"
    echo "    -c => clean first"
    echo "    -C => don't clean first (default)"
    echo "  BUILDS:"
    echo "    debug"
    echo "    nothread"
    echo "    valgrind"
    echo "    rooting"
    echo "    release"
    exit 1
}

LOGFILE=jsbuild.log

COMMON_OPTS="--with-ccache=`which ccache`"
THREAD_OPTS="--with-system-nspr --enable-threadsafe"
DEBUG_OPTS="--enable-debug --disable-optimize --enable-gczeal"
VALGRIND_OPTS="--disable-jemalloc --enable-valgrind"
ROOTING_OPTS="--enable-root-analysis"

NOTHREAD_CONFIG="$COMNON_OPTS $DEBUG_OPTS"
DEBUG_CONFIG="$COMMON_OPTS $DEBUG_OPTS $THREAD_OPTS"
VALGRIND_CONFIG="$COMMON_OPTS $DEBUG_OPTS $THREAD_OPTS $VALGRIND_OPTS"
ROOTING_CONFIG="$COMNON_OPTS $DEBUG_OPTS $ROOTING_OPTS"
RELEASE_CONFIG="$COMNON_OPTS"

CLEAN=
DEBUG=
NOTHREAD=
VALGRIND=
ROOTING=
RELEASE=

while [ $# -ge 1 ]; do
    case "$1" in
        -c)
            CLEAN=t
            ;;
        -C)
            CLEAN=
            ;;
        debug)
            DEBUG=t
            ;;
        nothread)
            NOTHREAD=t
            ;;
        release)
            RELEASE=t
            ;;
        valgrind)
            VALGRIND=t
            ;;
        rooting)
            ROOTING=t
            ;;
        *)
            badUsage
            ;;
    esac
    shift
done

if [ -z "$DEBUG" -a -z "$NOTHREAD" -a -z "$VALGRIND" -a -z "$ROOTING" -a -z "$RELEASE" ]; then
    DEBUG=t
fi

if [ ! -e ./jsapi.h ]; then
    echo Run jsbuild from the tree/js/src directory
    exit 1
fi

function fail()
{
    echo "Build failed, see $LOGFILE"
    exit 1
}

function build()
{
    local NAME=$1
    local DIR=$2
    local CONFIG=$3
    local CLEAN=$4

    if [ -n "$CLEAN" ]; then
        echo "Clean $NAME"
        rm -rf $DIR
    fi

    if [ ! -d $DIR ]; then
        echo "Configure $NAME"
        mkdir $DIR
        cd $DIR
        echo configure $CONFIG > $LOGFILE
        ../configure $CONFIG >> $LOGFILE 2>&1 || fail
        cd ..
    fi

    echo "Build $NAME"
    make -C $DIR -j8 2>&1 | tee -a $DIR/$LOGFILE | grep -iE "warning:|error:"
    if [ ${PIPESTATUS[0]} -ne "0" ]; then
        fail
    fi
}

rm -f $LOGFILE

# Find installed compilers
CLANGCC=`which clang`
CLANGCXX=`which clang++`
GCC=`which gcc`
GXX=`which g++`
if [ -z "$CLANGCC" -a -z "$CLANGCXX" -a -z "$GCC" -a -z "$GXX" ]; then
    echo "Can't find gcc or clang on path"
    exit 1
fi

if [ configure.in -nt configure ]; then

    echo "Autoconf"
    AUTOCONF=`which autoconf213`
    if [ -z "$AUTOCONF" ]; then
        AUTOCONF=`which autoconf2.13`
    fi
    if [ -z "$AUTOCONF" ]; then
        echo "Can't find autoconf 2.13"
        exit 1
    fi
    $AUTOCONF || fail

    echo "Clean all"
    rm -rf debug-build nothread-build valgrind-build rooting-build release-build
    CLEAN=
fi

# Use gcc for most builds, if installed
if [ -n "$GCC" -a -n "$GXX" ]; then
    export CC=$GCC
    export CXX=$GXX
fi

if [ -n "$DEBUG" ]; then
    build debug debug-build "$DEBUG_CONFIG" "$CLEAN"
fi

if [ -n "$NOTHREAD" ]; then
    build nothread nothread-build "$NOTHREAD_CONFIG" "$CLEAN"
fi

if [ -n "$VALGRIND" ]; then
    build valgrind valgrind-build "$VALGRIND_CONFIG" "$CLEAN"
fi

if [ -n "$RELEASE" ]; then
    build release release-build "$RELEASE_CONFIG" "$CLEAN"
fi

# Use clang for rooting builds, if installed
if [ -n "$CLANGCC" -a -n "$CLANGCXX" ]; then
    export CC=$CLANGCC
    export CXX=$CLANGCXX
fi

if [ -n "$ROOTING" ]; then
    build rooting rooting-build "$ROOTING_CONFIG" "$CLEAN"
fi
