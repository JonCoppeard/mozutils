#!/bin/bash

function badUsage()
{
    echo "jsbuild OPTIONS BUILDS"
    echo "  OPTIONS:"
    echo "    -c => clean first"
    echo "    -C => don't clean first (default)"
    echo "    -w => show warnings"
    echo "  BUILDS:"
    echo "    debug"
    echo "    release"
    echo "    rooting"
    echo "    exact"
    echo "    ggc"
    exit 1
}

LOGFILE=jsbuild.log

COMMON_OPTS="--with-ccache=`which ccache`"
THREAD_OPTS="--with-system-nspr --enable-threadsafe --enable-ctypes" # ctypes requires nspr it seems
DEBUG_OPTS="--enable-debug --disable-optimize --enable-gczeal"
ROOTING_OPTS="--enable-root-analysis --disable-threadsafe"
EXACT_OPTS="--enable-exact-rooting --disable-threadsafe"
GGC_OPTS="--enable-gcgenerational --enable-exact-rooting --disable-threadsafe"

DEBUG_CONFIG="$COMMON_OPTS $DEBUG_OPTS $THREAD_OPTS"
RELEASE_CONFIG="$COMMON_OPTS"
ROOTING_CONFIG="$COMMON_OPTS $DEBUG_OPTS $ROOTING_OPTS"
EXACT_CONFIG="$COMMON_OPTS $DEBUG_OPTS $EXACT_OPTS"
GGC_CONFIG="$COMMON_OPTS $DEBUG_OPTS $GGC_OPTS"

CLEAN=
WARN=
DEBUG=
RELEASE=
ROOTING=
EXACT=
GGC=

while [ $# -ge 1 ]; do
    case "$1" in
        -c)
            CLEAN=t
            ;;
        -C)
            CLEAN=
            ;;
        -w)
            WARN=t
            ;;
        debug)
            DEBUG=t
            ;;
        release)
            RELEASE=t
            ;;
        rooting)
            ROOTING=t
            ;;
        exact)
            EXACT=t
            ;;
        ggc)
            GGC=t
            ;;
        *)
            badUsage
            ;;
    esac
    shift
done

if [ -z "$DEBUG" -a -z "$RELEASE" -a -z "$ROOTING" -a -z "$EXACT" ]; then
    DEBUG=t
fi

FILTER="error:"
if [ -n "$WARN" ]; then
    FILTER="$FILTER|warning:"
fi

if [ ! -e ./jsapi.h ]; then
    echo Run jsbuild from the tree/js/src directory
    exit 1
fi

function fail()
{
    echo "Build failed, see $LOGFILE"
    exit 1
}

function build()
{
    local NAME=$1
    local DIR=$2
    local CONFIG=$3
    local CLEAN=$4

    if [ -n "$CLEAN" ]; then
        echo "Clean $NAME"
        rm -rf $DIR
    fi

    if [ ! -d $DIR ]; then
        echo "Configure $NAME"
        mkdir $DIR
        cd $DIR
        echo configure $CONFIG > $LOGFILE
        ../configure $CONFIG 2>&1 | tee -a $LOGFILE | grep -iE $FILTER
        if [ ${PIPESTATUS[0]} -ne "0" ]; then
            fail
        fi
        cd ..
    fi

    echo "Build $NAME"
    nice make -C $DIR -j8 2>&1 | tee -a $DIR/$LOGFILE | grep -iE $FILTER
    if [ ${PIPESTATUS[0]} -ne "0" ]; then
        fail
    fi
}

rm -f $LOGFILE

if [ configure.in -nt configure ]; then

    echo "Autoconf"
    AUTOCONF=`which autoconf213`
    if [ -z "$AUTOCONF" ]; then
        AUTOCONF=`which autoconf2.13`
    fi
    if [ -z "$AUTOCONF" ]; then
        echo "Can't find autoconf 2.13"
        exit 1
    fi
    $AUTOCONF || fail

    echo "Clean all"
    rm -rf debug-build nothread-build valgrind-build rooting-build release-build
    CLEAN=
fi

# Clang is preferred for rooting builds (it shows up more problems), and it much
# faster in general, so use it if possible
CLANGCC=`which clang`
CLANGCXX=`which clang++`
if [ -n "$CLANGCC" -a -n "$CLANGCXX" ]; then
    export CC=$CLANGCC
    export CXX=$CLANGCXX
fi

if [ -n "$DEBUG" ]; then
    build debug debug-build "$DEBUG_CONFIG" "$CLEAN"
fi

if [ -n "$RELEASE" ]; then
    build release release-build "$RELEASE_CONFIG" "$CLEAN"
fi

if [ -n "$ROOTING" ]; then
    build rooting rooting-build "$ROOTING_CONFIG" "$CLEAN"
fi

if [ -n "$EXACT" ]; then
    build exact exact-build "$EXACT_CONFIG" "$CLEAN"
fi

if [ -n "$GGC" ]; then
    build ggc ggc-build "$GGC_CONFIG" "$CLEAN"
fi
